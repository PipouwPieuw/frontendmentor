var gridW=7;var gridH=6;var grid=[...new Array(gridW)].map(elem=>new Array(gridH));var players=["p1","p2"];var activePlayer="";var defaultTimer=30;var currentTimer=defaultTimer;var countdown;var stopTimer=false;var scoreP1=0;var scoreP2=0;var gameActive=false;var gameMode="";window.onload=function(){var gridElem=document.getElementById("grid");for(let i=0;i<gridW;i++){var gridCol=document.createElement("span");gridCol.classList.add("grid__col");gridCol.setAttribute("data-index",i);for(let i=0;i<gridH;i++){var gridCell=document.createElement("span");gridCell.classList.add("grid__cell");gridCell.setAttribute("data-index",i);gridCol.appendChild(gridCell)}gridElem.appendChild(gridCol)}document.querySelectorAll(".grid__col").forEach(gridCol=>{gridCol.addEventListener("click",event=>{if(gridCol.classList.contains("grid__col--filled"))return false;stopTimer=true;document.querySelector(".grid").style.pointerEvents="none";var colIndex=parseInt(gridCol.getAttribute("data-index"));var query=gridCol.querySelectorAll(".grid__cell:not(.grid__cell--filled)");var targetCell=query[query.length-1];var token=document.createElement("span");token.classList.add("grid__token");token.classList.add("grid__token--"+activePlayer);var cellSize=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--cell-size"));var cellIndex=parseInt(targetCell.getAttribute("data-index"));var speed=Math.max((cellIndex+1)*40,100);token.style.transitionDuration=speed+"ms";gridCol.appendChild(token);sleep(200).then(()=>token.style.top=cellSize*cellIndex+"px").then(()=>sleep(speed)).then(()=>{targetCell.classList.add("grid__cell--filled");targetCell.classList.add("grid__cell--"+activePlayer);gridCol.removeChild(token);if(cellIndex==0)gridCol.classList.add("grid__col--filled")}).then(()=>sleep(100)).then(()=>{grid[colIndex][cellIndex]=activePlayer;if(!checkVictory(activePlayer,colIndex,cellIndex)){if(checkStalemate()){markVictory([],"neutral",true)}else{changePlayer(getNewPlayer());document.querySelector(".grid").style.pointerEvents="all"}}})})});document.querySelectorAll(".js_launch_player").forEach(elem=>{elem.addEventListener("click",function(){launchGame("player")})});document.querySelectorAll(".js_launch_cpu").forEach(elem=>{elem.addEventListener("click",function(){launchGame("cpu")})});document.querySelectorAll(".js_restart").forEach(elem=>{elem.addEventListener("click",function(){resetGrid()})});document.querySelectorAll(".js_reset").forEach(elem=>{elem.addEventListener("click",function(){resetGame()})});document.querySelectorAll(".js_reset_pause").forEach(elem=>{elem.addEventListener("click",function(){resetGame();closePause(true)})});document.querySelectorAll(".js_open_pause").forEach(elem=>{elem.addEventListener("click",function(){openPause()})});document.querySelectorAll(".js_close_pause").forEach(elem=>{elem.addEventListener("click",function(){closePause()})});document.querySelectorAll(".js_quit").forEach(elem=>{elem.addEventListener("click",function(){closePause();quitGame()})});document.querySelectorAll(".js_show_rules").forEach(elem=>{elem.addEventListener("click",function(){openRules()})});document.querySelectorAll(".js_close_rules").forEach(elem=>{elem.addEventListener("click",function(){closeRules()})})};function launchGame(mode){gameMode=mode;if(gameMode=="player"){document.getElementById("avatar_p2").classList.add("visible");document.getElementById("avatar_cpu").classList.remove("visible")}else{document.getElementById("avatar_p2").classList.remove("visible");document.getElementById("avatar_cpu").classList.add("visible")}document.getElementById("modal_main").classList.remove("visible");document.getElementById("modal_main_overlay").classList.remove("visible");changePlayer("p1")}function quitGame(){document.getElementById("modal_main").classList.add("visible");document.getElementById("modal_main_overlay").classList.add("visible");resetGame(false)}function openPause(){stopTimer=true;document.getElementById("modal_pause").classList.add("visible");document.getElementById("modal_pause_overlay").classList.add("visible")}function closePause(restart=false){document.getElementById("modal_pause").classList.remove("visible");document.getElementById("modal_pause_overlay").classList.remove("visible");if(gameActive&&!restart)launchTimer(false)}function openRules(){document.getElementById("modal_rules").classList.add("visible");document.getElementById("modal_rules_overlay").classList.add("visible")}function closeRules(){document.getElementById("modal_rules").classList.remove("visible");document.getElementById("modal_rules_overlay").classList.remove("visible")}function resetGame(relaunch=true){stopTimer=true;gameActive=false;resetGrid(false);scoreP1=0;scoreP2=0;document.getElementById("score_p1").innerHTML=0;document.getElementById("score_p2").innerHTML=0;if(relaunch)changePlayer("p1")}function changePlayer(player=""){if(player=="")player=players[0];activePlayer=player;document.body.setAttribute("data-player",activePlayer);document.querySelector(".js_current_player--p1").classList.add("hidden");document.querySelector(".js_current_player--p2").classList.add("hidden");document.querySelector(".js_current_player--"+player).classList.remove("hidden");if(activePlayer=="p2"&&gameMode=="cpu"){cpuTurn()}else{gameActive=true;launchTimer()}}function getNewPlayer(){return["p2",""].includes(activePlayer)?"p1":"p2"}function sleep(ms){return new Promise(resolve=>setTimeout(resolve,ms))}function launchTimer(reset=true){var timerElem=document.getElementById("countdown");if(reset){clearInterval(countdown);currentTimer=defaultTimer;timerElem.innerHTML=currentTimer}stopTimer=false;countdown=setInterval(()=>{if(currentTimer==1||stopTimer){clearInterval(countdown);if(currentTimer==1){document.querySelector(".grid").style.pointerEvents="none";markVictory([],getNewPlayer())}}else{currentTimer--;timerElem.innerHTML=currentTimer}},1e3)}function checkVictory(player,col,cell){var currentCells=[[col,cell]];var tempCells=[];var processLoop=true;var counter=col;while(processLoop){counter-=1;if(counter<0||grid[counter][cell]!=player)processLoop=false;else tempCells.push([counter,cell])}counter=col;processLoop=true;while(processLoop){counter+=1;if(counter>=gridW||grid[counter][cell]!=player)processLoop=false;else tempCells.push([counter,cell])}if(tempCells.length>=3)currentCells.push(...tempCells);tempCells=[];counter=cell;processLoop=true;while(processLoop){counter+=1;if(counter>=gridH||grid[col][counter]!=player)processLoop=false;else tempCells.push([col,counter])}if(tempCells.length>=3)currentCells.push(...tempCells);tempCells=[];currentCol=col;currentCell=cell;processLoop=true;while(processLoop){currentCol-=1;currentCell+=1;if(currentCol<0||currentCell>=gridH||grid[currentCol][currentCell]!=player)processLoop=false;else tempCells.push([currentCol,currentCell])}currentCol=col;currentCell=cell;processLoop=true;while(processLoop){currentCol+=1;currentCell-=1;if(currentCol>=gridW||currentCell<0||grid[currentCol][currentCell]!=player)processLoop=false;else tempCells.push([currentCol,currentCell])}if(tempCells.length>=3)currentCells.push(...tempCells);tempCells=[];currentCol=col;currentCell=cell;processLoop=true;while(processLoop){currentCol-=1;currentCell-=1;if(currentCol<0||currentCell<0||grid[currentCol][currentCell]!=player)processLoop=false;else tempCells.push([currentCol,currentCell])}currentCol=col;currentCell=cell;processLoop=true;while(processLoop){currentCol+=1;currentCell+=1;if(currentCol>=gridW||currentCell>=gridH||grid[currentCol][currentCell]!=player)processLoop=false;else tempCells.push([currentCol,currentCell])}if(tempCells.length>=3)currentCells.push(...tempCells);if(currentCells.length>=4){markVictory(currentCells,player);return true}else return false}function setCellScore(player,col,cell){var maxScore=0;var tempCells=[];var processLoop=true;var counter=col;while(processLoop){counter-=1;if(counter<0||grid[counter][cell]!=player)processLoop=false;else tempCells.push([counter,cell])}counter=col;processLoop=true;while(processLoop){counter+=1;if(counter>=gridW||grid[counter][cell]!=player)processLoop=false;else tempCells.push([counter,cell])}if(tempCells.length>maxScore)maxScore=tempCells.length;tempCells=[];counter=cell;processLoop=true;while(processLoop){counter+=1;if(counter>=gridH||grid[col][counter]!=player)processLoop=false;else tempCells.push([col,counter])}if(tempCells.length>maxScore)maxScore=tempCells.length;tempCells=[];currentCol=col;currentCell=cell;processLoop=true;while(processLoop){currentCol-=1;currentCell+=1;if(currentCol<0||currentCell>=gridH||grid[currentCol][currentCell]!=player)processLoop=false;else tempCells.push([currentCol,currentCell])}currentCol=col;currentCell=cell;processLoop=true;while(processLoop){currentCol+=1;currentCell-=1;if(currentCol>=gridW||currentCell<0||grid[currentCol][currentCell]!=player)processLoop=false;else tempCells.push([currentCol,currentCell])}if(tempCells.length>maxScore)maxScore=tempCells.length;tempCells=[];currentCol=col;currentCell=cell;processLoop=true;while(processLoop){currentCol-=1;currentCell-=1;if(currentCol<0||currentCell<0||grid[currentCol][currentCell]!=player)processLoop=false;else tempCells.push([currentCol,currentCell])}currentCol=col;currentCell=cell;processLoop=true;while(processLoop){currentCol+=1;currentCell+=1;if(currentCol>=gridW||currentCell>=gridH||grid[currentCol][currentCell]!=player)processLoop=false;else tempCells.push([currentCol,currentCell])}if(tempCells.length>maxScore)maxScore=tempCells.length;return maxScore}function markVictory(cells,player,isStalemate=false){gameActive=false;for(index in cells){var[col,cell]=cells[index];document.querySelector('.grid__col[data-index="'+col+'"] .grid__cell[data-index="'+cell+'"]').classList.add("grid__cell--victory")}if(!isStalemate){document.querySelector(".js_board").classList.remove("board--neutral");document.querySelector(".js_board").classList.add("board--"+player);document.querySelector(".js_winner--p1").classList.add("hidden");document.querySelector(".js_winner--p2").classList.add("hidden");document.querySelector(".js_winner--"+player).classList.remove("hidden");document.querySelector(".js_victory").classList.remove("hidden");if(player=="p1"){scoreP1+=1;document.getElementById("score_p1").innerHTML=scoreP1}else{scoreP2+=1;document.getElementById("score_p2").innerHTML=scoreP2}}else{document.querySelector(".js_stalemate").classList.remove("hidden")}document.querySelector(".js_timer").classList.add("hidden")}function resetGrid(relaunch=true){grid=[...new Array(gridW)].map(elem=>new Array(gridH));document.querySelectorAll(".grid__col").forEach(elem=>{elem.classList.remove("grid__col--filled")});document.querySelectorAll(".grid__cell").forEach(elem=>{elem.classList.remove("grid__cell--filled");elem.classList.remove("grid__cell--p1");elem.classList.remove("grid__cell--p2");elem.classList.remove("grid__cell--victory")});document.querySelector(".grid").style.pointerEvents="all";document.querySelector(".js_timer").classList.remove("hidden");document.querySelector(".js_victory").classList.add("hidden");document.querySelector(".js_stalemate").classList.add("hidden");document.querySelector(".js_board").classList.remove("board--p1");document.querySelector(".js_board").classList.remove("board--p2");document.querySelector(".js_board").classList.add("board--neutral");if(relaunch){players.push(players.shift());changePlayer()}}function checkStalemate(){var query=document.querySelectorAll(".grid__col:not(.grid__col--filled)");return query.length==0}function cpuTurn(){var indexes=[];var scores=[];var bestCells=[];document.querySelectorAll(".grid__col").forEach(gridCol=>{if(gridCol.classList.contains("grid__col--filled"))return false;var colIndex=parseInt(gridCol.getAttribute("data-index"));var query=gridCol.querySelectorAll(".grid__cell:not(.grid__cell--filled)");var targetCell=query[query.length-1];var cellIndex=parseInt(targetCell.getAttribute("data-index"));var cellScore=setCellScore(activePlayer,colIndex,cellIndex);indexes.push(colIndex);scores.push(cellScore)});var maxScore=Math.max(...scores);for(let i=0;i<indexes.length;i++)if(scores[i]==maxScore)bestCells.push(indexes[i]);shuffledBestCells=bestCells.sort((a,b)=>.5-Math.random());var playedCell=shuffledBestCells[0];document.querySelectorAll('.grid__col[data-index="'+playedCell+'"]').forEach(elem=>{elem.click()})}